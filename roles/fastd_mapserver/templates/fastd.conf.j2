# {{ ansible_managed }} 

# Set the user, fastd will work as
user "nobody";

# Set the interface name
interface "mesh-vpn{{ item.value.number }}";

# Set the mode, the interface will work as
mode tap;

# Set the mtu of the interface (salsa2012 with ipv6 will need 1406)
mtu 1406;

# Set the methods (aes128-gcm preferred, salsa2012+umac preferred for nodes)
method "aes128-gcm";
method "salsa2012+umac";
method "salsa2012+gmac";

# Secret key generated by `fastd --generate-key`
include "../secret.key";

# Log everything to syslog
log to syslog level debug;

# Include peers from our git-repos
peer group "vpn{{ item.value.number }}" {
    peer limit 1;
    include peers from "/etc/fastd/vpn{{ item.value.number }}/peers/";
}

# Status Socket
status socket "/tmp/fastd-status{{ item.value.number }}";

# Configure a shell command that is run on connection attempts by unknown peers (true means, all attempts are accepted)
on verify "false";

# Configure a shell command that is run when fastd comes up
on up "
  chmod ugo+rw /tmp/fastd-status{{ item.value.number }}
  ip link set dev $INTERFACE address de:ad:be:ef:99:{{ item.value.number }}
  ip link set dev $INTERFACE up
  batctl -m bat{{ item.value.number }} if add $INTERFACE
  echo 1 > /sys/devices/virtual/net/$INTERFACE/batman_adv/no_rebroadcast
";
